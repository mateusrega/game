<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>CatTroll</title>

<style>
:root{
  --bg:#0b0f1a;
  --panel:#141a2a;
  --tile:#4caf50;
  --goal:#e53935;
  --spawn:#ffca28;
  --accent:#2979ff;
}

body{
  margin:0;
  font-family:Arial, sans-serif;
  background:var(--bg);
  color:#fff;
  user-select:none;
}

button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  background:#2a2f45;
  color:#fff;
  font-weight:bold;
}

button.active{
  background:var(--accent);
  box-shadow:0 0 10px var(--accent);
}

#editor-tela,#jogo-tela{
  display:none;
  flex-direction:column;
  align-items:center;
  gap:10px;
  padding:10px;
}

#editor-tela{display:flex;}

#toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
}

#grid{
  display:grid;
  background:#000;
  touch-action:none;
}

.tile{
  width:16px;
  height:16px;
  border:1px solid #111;
}
.platform{background:var(--tile);}
.goal{background:var(--goal);}
.spawn{background:var(--spawn);}

canvas{background:#000;}

#joystick{
  position:fixed;
  bottom:20px;
  left:20px;
  width:120px;
  height:120px;
  border-radius:50%;
  background:rgba(255,255,255,.1);
  display:none;
}
#stick{
  position:absolute;
  width:50px;
  height:50px;
  border-radius:50%;
  background:rgba(255,255,255,.5);
  left:35px;
  top:35px;
}
</style>
</head>

<body>

<div id="editor-tela">
  <div id="toolbar">
    <button id="bPlat" onclick="setModo('plataforma')">Plataforma</button>
    <button id="bSpawn" onclick="setModo('spawn')">Spawn</button>
    <button id="bGoal" onclick="setModo('goal')">Chegada</button>
    <button onclick="mostrarJogo()">Testar Fase</button>
  </div>
  <div id="grid"></div>
</div>

<div id="jogo-tela">
  <canvas id="game" width="360" height="640"></canvas>
</div>

<div id="joystick">
  <div id="stick"></div>
</div>

<script>
/* ===== EDITOR ===== */
const TILE=16;
let COLS=Math.floor(innerWidth*0.9/TILE);
let ROWS=Math.floor(innerHeight*0.6/TILE);
let map=Array.from({length:ROWS},()=>Array(COLS).fill(0));
let modo='plataforma';
let pintando=false;

const grid=document.getElementById('grid');
grid.style.gridTemplateColumns=`repeat(${COLS},${TILE}px)`;

function setModo(m){
  modo=m;
  document.querySelectorAll('#toolbar button').forEach(b=>b.classList.remove('active'));
  if(m==='plataforma')bPlat.classList.add('active');
  if(m==='spawn')bSpawn.classList.add('active');
  if(m==='goal')bGoal.classList.add('active');
}
setModo('plataforma');

function criarGrid(){
  grid.innerHTML='';
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      const d=document.createElement('div');
      d.className='tile';
      if(map[y][x]==1)d.classList.add('platform');
      if(map[y][x]==2)d.classList.add('goal');
      if(map[y][x]==3)d.classList.add('spawn');
      d.onpointerdown=()=>{pintar(x,y);pintando=true;}
      d.onpointerenter=()=>{if(pintando)pintar(x,y);}
      grid.appendChild(d);
    }
  }
}
window.onpointerup=()=>pintando=false;

function limpar(valor){
  for(let y=0;y<ROWS;y++)
    for(let x=0;x<COLS;x++)
      if(map[y][x]==valor)map[y][x]=0;
}

function pintar(x,y){
  if(modo==='plataforma')map[y][x]=1;
  if(modo==='goal'){limpar(2);map[y][x]=2;}
  if(modo==='spawn'){limpar(3);map[y][x]=3;}
  criarGrid();
}
criarGrid();

/* ===== JOGO ===== */
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');

const player={x:0,y:0,w:16,h:16,vx:0,vy:0,onGround:false};
const img=new Image();
img.src="assets/icon-512.png";

const gravity=0.4;
let keys={l:false,r:false};

function achar(valor){
  for(let y=0;y<ROWS;y++)
    for(let x=0;x<COLS;x++)
      if(map[y][x]==valor)return{x,y};
  return null;
}

function colisao(nx,ny){
  const l=Math.floor(nx/TILE);
  const r=Math.floor((nx+player.w)/TILE);
  const t=Math.floor(ny/TILE);
  const b=Math.floor((ny+player.h)/TILE);
  return map[t]?.[l]==1||map[t]?.[r]==1||map[b]?.[l]==1||map[b]?.[r]==1;
}

function update(){
  player.vy+=gravity;
  if(!colisao(player.x,player.y+player.vy)){
    player.y+=player.vy;
    player.onGround=false;
  }else{
    player.vy=0;
    player.onGround=true;
  }

  if(keys.l&&!colisao(player.x-2,player.y))player.x-=2;
  if(keys.r&&!colisao(player.x+2,player.y))player.x+=2;

  const cx=Math.floor((player.x+8)/TILE);
  const cy=Math.floor((player.y+8)/TILE);
  if(map[cy]?.[cx]==2){
    alert("ðŸŽ‰ Venceu!");
    mostrarEditor();
  }

  if(player.y>canvas.height){
    alert("ðŸ’€ Caiu!");
    mostrarEditor();
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<ROWS;y++)
    for(let x=0;x<COLS;x++){
      if(map[y][x]==1)ctx.fillStyle="#4caf50";
      if(map[y][x]==2)ctx.fillStyle="#e53935";
      if(map[y][x]==3)ctx.fillStyle="#ffca28";
      if(map[y][x])ctx.fillRect(x*TILE,y*TILE,TILE,TILE);
    }
  ctx.drawImage(img,player.x,player.y,player.w,player.h);
}

function loop(){update();draw();requestAnimationFrame(loop);}

function mostrarJogo(){
  const spawn=achar(3);
  const goal=achar(2);
  if(!spawn||!goal){
    alert("âš ï¸ Spawn e Chegada sÃ£o obrigatÃ³rios!");
    return;
  }
  editor-tela.style.display="none";
  jogo-tela.style.display="flex";
  joystick.style.display="block";
  player.x=spawn.x*TILE;
  player.y=spawn.y*TILE;
  player.vy=0;
  loop();
}

function mostrarEditor(){
  editor-tela.style.display="flex";
  jogo-tela.style.display="none";
  joystick.style.display="none";
}

/* ===== CONTROLES ===== */
onkeydown=e=>{
  if(e.key=="ArrowLeft")keys.l=true;
  if(e.key=="ArrowRight")keys.r=true;
  if(e.key=="ArrowUp"&&player.onGround)player.vy=-8;
}
onkeyup=e=>{
  if(e.key=="ArrowLeft")keys.l=false;
  if(e.key=="ArrowRight")keys.r=false;
}

/* ===== JOYSTICK ===== */
const joy=document.getElementById('joystick');
const stick=document.getElementById('stick');

joy.onpointermove=e=>{
  if(e.buttons){
    let x=e.offsetX-60;
    if(x<-15)keys.l=true; else keys.l=false;
    if(x>15)keys.r=true; else keys.r=false;
    stick.style.left=60+Math.max(-40,Math.min(40,x))-25+"px";
  }
};
joy.onpointerup=()=>{
  stick.style.left="35px";
  keys.l=keys.r=false;
};
</script>
</body>
</html>
