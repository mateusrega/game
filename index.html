<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>CatTroll</title>

<style>
body{
  margin:0;
  background:#111;
  color:#fff;
  font-family:Arial, sans-serif;
  user-select:none;
  overflow:hidden;
}

button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  background:#333;
  color:#fff;
  font-weight:bold;
}
button.active{ background:#2196f3; }

#editor,#jogo{
  position:absolute;
  inset:0;
  display:none;
  flex-direction:column;
  align-items:center;
  gap:8px;
  padding:8px;
}

#editor{ display:flex; }

#toolbar{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  justify-content:center;
}

#editorView{
  width:100%;
  height:100%;
  overflow:hidden;
  border:2px solid #333;
  touch-action:none;
}

#grid{
  position:absolute;
  display:grid;
  background:#000;
}

.tile{
  width:16px;
  height:16px;
  box-sizing:border-box;
  border:1px solid #111;
}

.platform{ background:#4caf50; }
.goal{ background:#e53935; }
.spawn{ background:#ffca28; }

canvas{
  background:#000;
}

/* overlays */
.overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.7);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:10px;
  font-size:20px;
}

/* joystick */
#joystick{
  position:fixed;
  bottom:20px;
  left:20px;
  width:120px;
  height:120px;
  border-radius:50%;
  background:rgba(255,255,255,.1);
  display:none;
}
#stick{
  position:absolute;
  width:50px;
  height:50px;
  border-radius:50%;
  background:rgba(255,255,255,.5);
  left:35px;
  top:35px;
}
</style>
</head>

<body>

<div id="editor">
  <div id="toolbar">
    <button id="bPlat">Plataforma</button>
    <button id="bSpawn">Spawn</button>
    <button id="bGoal">Chegada</button>
    <button id="bDel">Delete</button>
    <button id="bUndo">Undo</button>
    <button id="bRedo">Redo</button>
    <button id="bZoomIn">+</button>
    <button id="bZoomOut">âˆ’</button>
    <button id="bTest">Testar</button>
  </div>

  <div id="editorView">
    <div id="grid"></div>
  </div>
</div>

<div id="jogo">
  <canvas id="canvas" width="360" height="480"></canvas>

  <div id="win" class="overlay" style="display:none">
    ðŸŽ‰ VocÃª Ganhou!
    <button onclick="restart()">Rejogar</button>
    <button onclick="mostrarEditor()">Editor</button>
  </div>

  <div id="lose" class="overlay" style="display:none">
    ðŸ’€ VocÃª Morreu
    <button onclick="restart()">Rejogar</button>
    <button onclick="mostrarEditor()">Editor</button>
  </div>
</div>

<div id="joystick"><div id="stick"></div></div>

<script>
/* ===== CONFIG ===== */
const TILE=16;
const MAP_W=200;
const MAP_H=120;

/* ===== MAPA ===== */
let map=Array.from({length:MAP_H},()=>Array(MAP_W).fill(0));
let modo="plataforma";

/* ===== UNDO / REDO ===== */
let undoStack=[];
let redoStack=[];
function saveState(){
  undoStack.push(JSON.stringify(map));
  if(undoStack.length>50)undoStack.shift();
  redoStack=[];
}

/* ===== EDITOR ===== */
const grid=document.getElementById("grid");
const view=document.getElementById("editorView");

let zoom=1;
let camX=0, camY=0;
let pintando=false;

function setModo(m){
  modo=m;
  document.querySelectorAll("#toolbar button").forEach(b=>b.classList.remove("active"));
  document.getElementById(
    m==="plataforma"?"bPlat":
    m==="spawn"?"bSpawn":
    m==="goal"?"bGoal":"bDel"
  ).classList.add("active");
}

function limpar(v){
  for(let y=0;y<MAP_H;y++)
    for(let x=0;x<MAP_W;x++)
      if(map[y][x]===v) map[y][x]=0;
}

function pintar(x,y){
  if(x<0||y<0||x>=MAP_W||y>=MAP_H)return;
  if(modo==="plataforma") map[y][x]=1;
  if(modo==="spawn"){ limpar(3); map[y][x]=3; }
  if(modo==="goal"){ limpar(2); map[y][x]=2; }
  if(modo==="delete") map[y][x]=0;
}

function render(){
  grid.innerHTML="";
  grid.style.transform=`translate(${camX}px,${camY}px) scale(${zoom})`;
  grid.style.gridTemplateColumns=`repeat(${MAP_W},${TILE}px)`;

  for(let y=0;y<MAP_H;y++)
    for(let x=0;x<MAP_W;x++){
      const d=document.createElement("div");
      d.className="tile";
      if(map[y][x]==1)d.classList.add("platform");
      if(map[y][x]==2)d.classList.add("goal");
      if(map[y][x]==3)d.classList.add("spawn");

      d.onmousedown=e=>{
        saveState();
        pintando=true;
        pintar(x,y);
        render();
      };
      d.onmouseenter=()=>{ if(pintando){ pintar(x,y); render(); } };

      grid.appendChild(d);
    }
}

document.onmouseup=()=>pintando=false;

/* arrastar cÃ¢mera */
let drag=false, lx=0, ly=0;
view.onmousedown=e=>{ drag=true; lx=e.clientX; ly=e.clientY; };
view.onmousemove=e=>{
  if(!drag)return;
  camX+=e.clientX-lx;
  camY+=e.clientY-ly;
  lx=e.clientX; ly=e.clientY;
  render();
};
document.onmouseup=()=>{ drag=false; pintando=false; };

render();

/* ===== BOTÃ•ES ===== */
bPlat.onclick=()=>setModo("plataforma");
bSpawn.onclick=()=>setModo("spawn");
bGoal.onclick=()=>setModo("goal");
bDel.onclick=()=>setModo("delete");

bUndo.onclick=()=>{
  if(!undoStack.length)return;
  redoStack.push(JSON.stringify(map));
  map=JSON.parse(undoStack.pop());
  render();
};
bRedo.onclick=()=>{
  if(!redoStack.length)return;
  undoStack.push(JSON.stringify(map));
  map=JSON.parse(redoStack.pop());
  render();
};

bZoomIn.onclick=()=>{ zoom=Math.min(3,zoom+0.2); render(); };
bZoomOut.onclick=()=>{ zoom=Math.max(0.5,zoom-0.2); render(); };

/* ===== JOGO ===== */
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const player={x:0,y:0,w:16,h:16,vx:0,vy:0,on:false};
const gravity=0.45;
let keys={l:false,r:false};
let joyX=0;
let estado="jogo";

/* sprite simples embutido */
const img=new Image();
img.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAMAAABhvppWAAAAGFBMVEUAAAD///+ZmZnMzMzx8fH5+fnPz8+qg0cOAAAABnRSTlMA////AP9/4+8AAAAPSURBVAjXY2AgDQAAADAAAceqhY4AAAAASUVORK5CYII=";

function achar(v){
  for(let y=0;y<MAP_H;y++)
    for(let x=0;x<MAP_W;x++)
      if(map[y][x]==v)return{x,y};
  return null;
}

function colisao(nx,ny){
  const l=Math.floor(nx/TILE);
  const r=Math.floor((nx+player.w-1)/TILE);
  const t=Math.floor(ny/TILE);
  const b=Math.floor((ny+player.h-1)/TILE);
  return map[t]?.[l]==1||map[t]?.[r]==1||map[b]?.[l]==1||map[b]?.[r]==1;
}

function update(){
  if(estado!=="jogo")return;

  player.vy+=gravity;
  if(!colisao(player.x,player.y+player.vy)){
    player.y+=player.vy;
    player.on=false;
  }else{
    player.vy=0;
    player.on=true;
  }

  player.vx=(keys.l?-1:0)+(keys.r?1:0)+joyX;
  player.vx=Math.max(-1,Math.min(1,player.vx))*2.5;
  if(!colisao(player.x+player.vx,player.y))player.x+=player.vx;

  if(player.y>MAP_H*TILE){ estado="lose"; lose.style.display="flex"; }

  const cx=Math.floor((player.x+8)/TILE);
  const cy=Math.floor((player.y+8)/TILE);
  if(map[cy]?.[cx]==2){ estado="win"; win.style.display="flex"; }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const camPX=player.x-canvas.width/2+player.w/2;
  const camPY=player.y-canvas.height/2+player.h/2;

  for(let y=0;y<MAP_H;y++)
    for(let x=0;x<MAP_W;x++){
      if(map[y][x]==1){ ctx.fillStyle="#4caf50"; ctx.fillRect(x*TILE-camPX,y*TILE-camPY,TILE,TILE); }
      if(map[y][x]==2){ ctx.fillStyle="#e53935"; ctx.fillRect(x*TILE-camPX,y*TILE-camPY,TILE,TILE); }
    }

  ctx.drawImage(img,player.x-camPX,player.y-camPY,player.w,player.h);
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }

function mostrarJogo(){
  const s=achar(3), g=achar(2);
  if(!s||!g) return alert("Spawn e Chegada obrigatÃ³rios");
  editor.style.display="none";
  jogo.style.display="flex";
  joystick.style.display="block";
  win.style.display=lose.style.display="none";
  estado="jogo";
  player.x=s.x*TILE;
  player.y=s.y*TILE;
  player.vy=0;
  loop();
}
function mostrarEditor(){
  jogo.style.display="none";
  editor.style.display="flex";
  joystick.style.display="none";
}

bTest.onclick=mostrarJogo;

/* ===== CONTROLES ===== */
onkeydown=e=>{
  if(e.key==="ArrowLeft")keys.l=true;
  if(e.key==="ArrowRight")keys.r=true;
  if((e.key==="ArrowUp"||e.key===" ")&&player.on)player.vy=-8;
};
onkeyup=e=>{
  if(e.key==="ArrowLeft")keys.l=false;
  if(e.key==="ArrowRight")keys.r=false;
};

/* joystick */
const joystick=document.getElementById("joystick");
joystick.addEventListener("touchmove",e=>{
  const r=joystick.getBoundingClientRect();
  joyX=Math.max(-1,Math.min(1,(e.touches[0].clientX-(r.left+60))/40));
});
joystick.addEventListener("touchend",()=>joyX=0);
</script>

</body>
</html>
