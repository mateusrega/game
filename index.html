<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>CatTroll</title>

<style>
body{
  margin:0;
  background:#111;
  color:#fff;
  font-family:Arial, sans-serif;
  user-select:none;
}

button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  background:#333;
  color:#fff;
  font-weight:bold;
  font-size:14px;
}

button:hover{ background:#555; }

#editor,#jogo{
  display:none;
  flex-direction:column;
  align-items:center;
  gap:10px;
  padding:10px;
}

#editor{ display:flex; }

#toolbar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
}

#grid{
  display:grid;
  background:#000;
  border:2px solid #444;
  touch-action:none;
}

.tile{
  width:16px;
  height:16px;
  border:1px solid #111;
}

.platform{ background:#4caf50; }
.goal{ background:#e53935; }
.spawn{ background:#ffca28; }

canvas{
  background:#000;
  border:2px solid #444;
}

.overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.75);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:12px;
}

#joystick{
  position:fixed;
  bottom:20px;
  left:20px;
  width:120px;
  height:120px;
  border-radius:50%;
  background:rgba(255,255,255,.08);
  display:none;
}
#stick{
  position:absolute;
  width:50px;
  height:50px;
  border-radius:50%;
  background:rgba(255,255,255,.45);
  left:35px;
  top:35px;
}

#jumpBtn{
  position:fixed;
  bottom:30px;
  right:30px;
  width:80px;
  height:80px;
  border-radius:50%;
  background:#2196f3;
  display:none;
}

/* versÃ£o discreta */
#versionTag{
  position:fixed;
  bottom:4px;
  right:6px;
  font-size:10px;
  opacity:.25;
  color:#aaa;
  pointer-events:none;
}
</style>
</head>

<body>

<div id="editor">
  <div id="toolbar">
    <button onclick="setModo('plataforma')">Plataforma</button>
    <button onclick="setModo('spawn')">Spawn</button>
    <button onclick="setModo('goal')">Chegada</button>
    <button onclick="setModo('delete')">Delete</button>
    <button onclick="mostrarJogo()">Testar</button>
  </div>
  <div id="grid"></div>
</div>

<div id="jogo">
  <div style="position:relative">
    <canvas id="canvas" width="360" height="480"></canvas>

    <div id="overlayWin" class="overlay" style="display:none">
      <h2>ðŸŽ‰ VocÃª Ganhou!</h2>
      <button onclick="mostrarJogo()">Rejogar</button>
      <button onclick="mostrarEditor()">Editor</button>
    </div>

    <div id="overlayLose" class="overlay" style="display:none">
      <h2>ðŸ’€ VocÃª Morreu</h2>
      <button onclick="mostrarJogo()">Rejogar</button>
      <button onclick="mostrarEditor()">Editor</button>
    </div>
  </div>
</div>

<div id="joystick"><div id="stick"></div></div>
<button id="jumpBtn">â¬†</button>
<div id="versionTag"></div>

<script>
/* ===== VERSIONAMENTO ===== */
let VERSION="0.017";
const versionTag=document.getElementById("versionTag");
versionTag.textContent="v"+VERSION;

let versionHistory=JSON.parse(localStorage.getItem("CatTroll_versions")||"{}");

function salvarVersao(){
  if(versionHistory[VERSION])return;
  versionHistory[VERSION]={
    map:JSON.parse(JSON.stringify(map)),
    data:Date.now()
  };
  localStorage.setItem("CatTroll_versions",JSON.stringify(versionHistory));
}

function restaurarVersao(v){
  if(!versionHistory[v])return alert("VersÃ£o nÃ£o encontrada");
  map=JSON.parse(JSON.stringify(versionHistory[v].map));
  render();
}

onkeydown=e=>{
  if(e.ctrlKey&&e.shiftKey&&e.key==="R"){
    const v=prompt("Restaurar versÃ£o:");
    if(v)restaurarVersao(v);
  }
};

/* ===== CONFIG ===== */
const TILE=16;
const COLS=Math.floor(innerWidth*0.9/TILE);
const ROWS=Math.floor(innerHeight*0.6/TILE);

/* ===== MAPA ===== */
let map=Array.from({length:ROWS},()=>Array(COLS).fill(0));
salvarVersao();

let modo="plataforma";
let pintando=false;

/* ===== EDITOR ===== */
const grid=document.getElementById("grid");
grid.style.gridTemplateColumns=`repeat(${COLS},${TILE}px)`;

function setModo(m){modo=m;}

function limpar(v){
  for(let y=0;y<ROWS;y++)
    for(let x=0;x<COLS;x++)
      if(map[y][x]===v)map[y][x]=0;
}

function pintar(x,y){
  if(modo==="plataforma")map[y][x]=1;
  if(modo==="spawn"){limpar(3);map[y][x]=3;}
  if(modo==="goal"){limpar(2);map[y][x]=2;}
  if(modo==="delete")map[y][x]=0;
  salvarVersao();
}

function render(){
  grid.innerHTML="";
  for(let y=0;y<ROWS;y++)
    for(let x=0;x<COLS;x++){
      const d=document.createElement("div");
      d.className="tile";
      if(map[y][x]==1)d.classList.add("platform");
      if(map[y][x]==2)d.classList.add("goal");
      if(map[y][x]==3)d.classList.add("spawn");
      d.onmousedown=()=>{pintando=true;pintar(x,y);render();}
      d.onmouseenter=()=>{if(pintando){pintar(x,y);render();}}
      grid.appendChild(d);
    }
}
onmouseup=()=>pintando=false;
render();

/* ===== JOGO ===== */
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const player={x:0,y:0,w:16,h:16,vx:0,vy:0,onGround:false};
const gravity=.45;

let keys={l:false,r:false};
let estado="jogo";

const win=document.getElementById("overlayWin");
const lose=document.getElementById("overlayLose");

function achar(v){
  for(let y=0;y<ROWS;y++)
    for(let x=0;x<COLS;x++)
      if(map[y][x]===v)return{x,y};
}

function colisao(nx,ny){
  const l=Math.floor(nx/TILE);
  const r=Math.floor((nx+15)/TILE);
  const t=Math.floor(ny/TILE);
  const b=Math.floor((ny+15)/TILE);
  return map[t]?.[l]==1||map[t]?.[r]==1||map[b]?.[l]==1||map[b]?.[r]==1;
}

function update(){
  if(estado!=="jogo")return;
  player.vy+=gravity;
  if(!colisao(player.x,player.y+player.vy)){
    player.y+=player.vy;
    player.onGround=false;
  }else{
    player.vy=0;
    player.onGround=true;
  }
  player.vx=(keys.l?-1:0)+(keys.r?1:0);
  player.vx=Math.max(-1,Math.min(1,player.vx))*2.5;
  if(!colisao(player.x+player.vx,player.y))player.x+=player.vx;
  if(player.y>canvas.height){estado="lose";lose.style.display="flex";}
  const cx=Math.floor((player.x+8)/TILE);
  const cy=Math.floor((player.y+8)/TILE);
  if(map[cy]?.[cx]==2){estado="win";win.style.display="flex";}
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<ROWS;y++)
    for(let x=0;x<COLS;x++)
      if(map[y][x]==1){
        ctx.fillStyle="#4caf50";
        ctx.fillRect(x*TILE,y*TILE,TILE,TILE);
      }
  ctx.fillStyle="#ff0";
  ctx.fillRect(player.x,player.y,16,16);
}

function loop(){update();draw();requestAnimationFrame(loop);}

function mostrarJogo(){
  const s=achar(3),g=achar(2);
  if(!s||!g)return alert("Spawn e Chegada obrigatÃ³rios");
  editor.style.display="none";
  jogo.style.display="flex";
  player.x=s.x*TILE;
  player.y=s.y*TILE-1;
  estado="jogo";
  loop();
}

function mostrarEditor(){
  jogo.style.display="none";
  editor.style.display="flex";
}
</script>

</body>
  </html>
